---
title: "BMIN503/EPID600 Project"
author: "Weilu Song"
output: 
  html_document:
    theme: paper 
    highlight: tango
---


***
Use this template to complete your project throughout the course. Your Final Project presentation will be based on the contents of this document. Replace the title/name above and text below with your own, but keep the headers. Feel free to change the theme and other display settings, but this is not required.

### Overview
To better control HIV infection among high risk population, it urgently needs to explore the relationship between related determinants that may affect Pre-Exposure Prophylaxis (PrEP) usage. Jilinde PrEP cohort study was conducted in Kenya, it contains over 1000 participants and over 100 variables that related to PrEP usage among high risk population. In this project, this dataset is used to analyze the potential PrEP predictors that may impact the PrEP usage among targeted population.\



The original files of this final project can be accessed from here: [Final project_Song](https://github.com/aaronwlsong/BMIN503_Final_Project) \
 

### Introduction 
Pre-Exposure Prophylaxis (PrEP) has been proven an effective way to prevent HIV infection, however, the PrEP coverage among high risk population is still low. The reason behind this challenge is complex, because using PrEP is determined by multiple factors such as social determinants, self-perception, and clinical history.Since those influence factors are interdisciplinary, it is hard to extract the highly associated variables to the outcome manually based on the individual experience. It is much easier if the advanced statistical method can be applied to help figure out the association and further, using the casual inference theory to explore the reason that causes the low usage of PrEP.

Addressing this issue, the two faculties provided solutions in different aspects.For exploration of associated factors, depend on the outcome type, we can choose linear regression model to select those statistically associated factors to outcome.  

Then the machine learning method can be used for the prediction analysis.If the binary outcome from the dataset, then we can use the random forest tree with k-cross validation to establish a model and then use ROC to see whether the model is sufficient to predict all related predictors.
Further, if we want to explore the causal inference among the model, we can use DAG to get minimal set of potential confounder based on the associated factors analysis, then establish G-computation model to further calculate.


##### Hypothsis


### Methods
Describe the data used and general methodological approach. Subsequently, incorporate full R code necessary to retrieve and clean data, and perform analysis. Be sure to include a description of code so that others (including your future self) can understand what you are doing and why. 

#### 1. Data preparation
```{r}
pacman::p_load(rio, here,skimr,tidyverse,dplyr,haven,codebook,knitr,BiocManager,rlist,tools,qdapTools,janitor,fastDummies,labelled,magrittr,plyr,readxl,data.table,purrr,stringr,readxl,tidyr,dplyr,fastDummies,questionr,sqldf, fs, kableExtra, lubridate, mice, VIM )
```

#####  Data loading
```{r}
df503<-rio::import(here::here("rawdata","jilinde_coh_2022aug.csv"))
# Set up 25%-dropping rule for all variables (drop off variables which have over 25% missing) 
dfmissing<-skim(df503)%>%
           as_tibble()%>%
  filter(complete_rate>=0.70)%>%
  filter(character.empty<= nrow(df503)*0.3)

df503new<-df503%>%
  select(dfmissing$skim_variable, partner_2, partner_3, longitude,latitude)%>%
  select(everything(),-c(data_access_group, part1_name))
```

#####  Data inspection & cleaning
```{r}
# Take a deep look to add back some variables, derived variables and simple imputation.

cols<-names(df503new)[!(names(df503new) %in% c("part1_period_start", "part1_period_end", "record_id","longitude","latitude"))]
df503new%>%
  mutate( partner_more=if_else(had_a_partner=="Yes" & (partner_2=="Yes"| partner_3=="Yes"), "Yes", "No"),
          part1_period_start=mdy(part1_period_start),
          part1_period_end=mdy(part1_period_end))%>%
  fill(longitude, latitude, .direction = "updown")%>%
   mutate_each_(funs(factor(.)),cols) #convert to factor
```

#####  Missing data inspection and imputation
```{r}
skim(df503new)

```

#### 2.Using Machine learning to explore variables 
##### Associated variable selection
##### ML model analysis

#### 3.Causal inferenece analysis

##### DAG bassed on ML result

##### Casusal inference model: G-computation

### Results
Describe your results and include relevant tables, plots, and code/comments used to obtain them. End with a brief conclusion of your findings related to the question you set out to address. You can include references if you'd like, but this is not required.

##### Table-1: Demographic comparision

##### Table-2: Adjusted test: Regression model

##### Table-3: Model comparision: ML model and casual inference model (G-computation)

##### Map for result